<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tizimga kirish - AI Platformasi</title>
<link rel="icon" type="image/jpeg" href="./images/careerpathlogo.jpg">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root{
        --primary-color:#4CAF50;
        --secondary-color:#2196F3;
        --background-color:#f0f2f5;
        --text-color:#333;
        --light-text-color:#fff;
        --card-bg:#fff;
        --border-color:#ddd;
    }

    *{
        box-sizing:border-box;
    }

    body{
        font-family:'Poppins',sans-serif;
        margin:0;
        display:flex;
        justify-content:center;
        align-items:center;
        min-height:100vh;
        background:var(--background-color);
        color:var(--text-color);
        position:relative;
    }

    body::before{
        content:'';
        position:absolute;
        top:0;left:0;
        width:100%;
        height:100%;
        background:url('../images/careerpathlogo.jpg') no-repeat center center/cover;
        filter:blur(0.9px) brightness(1);
        z-index:-1;
    }

  .container{
    width:100%;
    max-width:450px;
    background:var(--card-bg);
    padding:40px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.1);
  }

  h2{
    text-align:center;
    color:var(--secondary-color);
    margin-bottom:30px;
  }

  .form-group{
    margin-bottom:20px;
  }

  .form-group label{
    display:block;
    margin-bottom:8px;
    font-weight:500;
  }

  .form-group input{
    width:100%;
    padding:12px;
    border:1px solid var(--border-color);
    border-radius:8px;
    font-family:'Poppins',sans-serif;
    font-size:1em;
  }

  .submit-btn{
    width:100%;
    padding:15px;
    background-color:var(--secondary-color);
    color:var(--light-text-color);
    border:none;
    border-radius:8px;
    font-size:1.1em;
    font-weight:600;
    cursor:pointer;
    transition:background-color .3s;
    }
    
  .submit-btn[disabled]{opacity:.7;cursor:not-allowed}

  .submit-btn:hover:not([disabled]){background-color:#1a7bb9}

  .link{
    text-align:center;
    margin-top:20px;
  }

  .link a{
    color:var(--primary-color);
    text-decoration:none;
    font-weight:600;
    }
</style>

<script defer src="https://cdn.jsdelivr.net/npm/@vercel/speed-insights/dist/inject.min.js"></script>

</head>
<body>

<div class="container" role="main">
  <h2>Tizimga kirish</h2>

  <form id="login-form">
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" required autocomplete="email">
    </div>
    <div class="form-group">
      <label for="password">Parol</label>
      <input type="password" id="password" name="password" required autocomplete="current-password">
    </div>
    <button type="submit" class="submit-btn" id="loginBtn">Tizimga kirish</button>
  </form>

  <div class="link">
    <p>Hali ro'yxatdan o'tmaganmisiz? <a href="register.html">Ro'yxatdan o'ting</a></p>
    
    <p>
      Parolni unutdingizmi? 
      <a href="forgot-password.html">Parolni tiklang</a>
    </p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA86zhSVi4FSw-GvFBdOZsCPaHMS67XA78",
    authDomain: "carrer-path-a5810.firebaseapp.com",
    projectId: "carrer-path-a5810",
    storageBucket: "carrer-path-a5810.firebasestorage.app",
    messagingSenderId: "693831778129",
    appId: "1:693831778129:web:911293c5c284eefe295d70"
  };

  const ACTION_URL = 'https://carrer-path-a5810.firebaseapp.com/__/auth/action';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginForm = document.getElementById('login-form');
  const loginBtn = document.getElementById('loginBtn');

  function setProcessing(on = true) {
    loginBtn.disabled = on;
    loginBtn.textContent = on ? 'Kuting...' : 'Tizimga kirish';
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) {
      alert("Iltimos, email va parolni kiriting.");
      return;
    }

    try {
      setProcessing(true);
      const cred = await signInWithEmailAndPassword(auth, email, password);
      const user = cred.user;

      if (!user.emailVerified) {
        const resend = confirm("Sizning emailingiz tasdiqlanmagan. Tasdiqlash xatini qayta yubormoqchimisiz?");
        if (resend) {
          await sendEmailVerification(user, { url: ACTION_URL });
          alert("Tasdiqlash xati yuborildi. Iltimos, emailingizni tekshirib tasdiqlang.");
        } else {
          alert("Iltimos, hisobingizni tasdiqlang yoki emailni qayta yuboring.");
        }
        await signOut(auth);
        setProcessing(false);
        return;
      }

      const uid = user.uid;
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);

      let role = 'user';
      if (userSnap.exists()) {
        role = userSnap.data().role || 'user';
      } else {
        role = 'user';
      }

      if (role === 'employer') {
        window.location.href = "careerpath.html";
      } else {
        window.location.href = "careerpath.html";
      }

    } catch (err) {
      console.error("Login error:", err);
      const msg = err && err.message ? err.message : "Tizimga kirishda noma'lum xato yuz berdi.";
      alert("Tizimga kirishda xato: " + msg);
      setProcessing(false);
    }
  });

  if (typeof injectSpeedInsights === 'function') {
    injectSpeedInsights();
  }
</script>
</body>
</html>
